
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "examples/ase_interface.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download_examples_ase_interface.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_ase_interface.py:


Structure minimization and constant temperature MD using ASE interface
======================================================================

This example is modified from the official `home page` and
`Constant temperature MD`_ to use the ASE interface of TorchANI as energy
calculator.

.. _home page:
    https://wiki.fysik.dtu.dk/ase/
.. _Constant temperature MD:
    https://wiki.fysik.dtu.dk/ase/tutorials/md/md.html#constant-temperature-md

.. GENERATED FROM PYTHON SOURCE LINES 18-19

To begin with, let's first import the modules we will use:

.. GENERATED FROM PYTHON SOURCE LINES 19-26

.. code-block:: default

    from ase.lattice.cubic import Diamond
    from ase.md.langevin import Langevin
    from ase.optimize import BFGS
    from ase import units
    import torchani









.. GENERATED FROM PYTHON SOURCE LINES 27-28

Now let's set up a crystal

.. GENERATED FROM PYTHON SOURCE LINES 28-31

.. code-block:: default

    atoms = Diamond(symbol="C", pbc=True)
    print(len(atoms), "atoms in the cell")





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    8 atoms in the cell




.. GENERATED FROM PYTHON SOURCE LINES 32-33

Now let's create a calculator from builtin models:

.. GENERATED FROM PYTHON SOURCE LINES 33-35

.. code-block:: default

    calculator = torchani.models.ANI1ccx().ase()





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/torchani-2.2.3.dev1+gc94ad7a-py3.8.egg/torchani/resources/
    Downloading ANI model parameters ...
    /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/torch/functional.py:1069: UserWarning: torch.meshgrid: in an upcoming release, it will be required to pass the indexing argument. (Triggered internally at  ../aten/src/ATen/native/TensorShape.cpp:2157.)
      return _VF.cartesian_prod(tensors)  # type: ignore[attr-defined]




.. GENERATED FROM PYTHON SOURCE LINES 36-46

.. note::
    Regardless of the dtype you use in your model, when converting it to ASE
    calculator, it always automatically the dtype to ``torch.float64``. The
    reason for this behavior is, at many cases, the rounding error is too
    large for structure minimization. If you insist on using
    ``torch.float32``, do the following instead:

    .. code-block:: python

        calculator = torchani.models.ANI1ccx().ase(dtype=torch.float32)

.. GENERATED FROM PYTHON SOURCE LINES 48-49

Now let's set the calculator for ``atoms``:

.. GENERATED FROM PYTHON SOURCE LINES 49-51

.. code-block:: default

    atoms.set_calculator(calculator)








.. GENERATED FROM PYTHON SOURCE LINES 52-53

Now let's minimize the structure:

.. GENERATED FROM PYTHON SOURCE LINES 53-59

.. code-block:: default

    print("Begin minimizing...")
    opt = BFGS(atoms)
    opt.run(fmax=0.001)
    print()






.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Begin minimizing...
    /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/torchani-2.2.3.dev1+gc94ad7a-py3.8.egg/torchani/ase.py:53: UserWarning: Creating a tensor from a list of numpy.ndarrays is extremely slow. Please consider converting the list to a single numpy.ndarray with numpy.array() before converting to a tensor. (Triggered internally at  ../torch/csrc/utils/tensor_new.cpp:201.)
      cell = torch.tensor(self.atoms.get_cell(complete=True),
    /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/torchani-2.2.3.dev1+gc94ad7a-py3.8.egg/torchani/aev.py:249: UserWarning: __floordiv__ is deprecated, and its behavior will change in a future version of pytorch. It currently rounds toward 0 (like the 'trunc' function NOT 'floor'). This results in incorrect rounding for negative values. To keep the current behavior, use torch.div(a, b, rounding_mode='trunc'), or for actual floor division, use torch.div(a, b, rounding_mode='floor').
      pair_sizes = counts * (counts - 1) // 2
          Step     Time          Energy         fmax
    BFGS:    0 00:17:30    -8311.226174        0.0000





.. GENERATED FROM PYTHON SOURCE LINES 60-61

Now create a callback function that print interesting physical quantities:

.. GENERATED FROM PYTHON SOURCE LINES 61-69

.. code-block:: default

    def printenergy(a=atoms):
        """Function to print the potential, kinetic and total energy."""
        epot = a.get_potential_energy() / len(a)
        ekin = a.get_kinetic_energy() / len(a)
        print('Energy per atom: Epot = %.3feV  Ekin = %.3feV (T=%3.0fK)  '
              'Etot = %.3feV' % (epot, ekin, ekin / (1.5 * units.kB), epot + ekin))









.. GENERATED FROM PYTHON SOURCE LINES 70-73

We want to run MD with constant energy using the Langevin algorithm
with a time step of 1 fs, the temperature 300K and the friction
coefficient to 0.02 atomic units.

.. GENERATED FROM PYTHON SOURCE LINES 73-76

.. code-block:: default

    dyn = Langevin(atoms, 1 * units.fs, 300 * units.kB, 0.2)
    dyn.attach(printenergy, interval=50)





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/ase/md/md.py:48: FutureWarning: Specify the temperature in K using the 'temperature_K' argument
      warnings.warn(FutureWarning(w))




.. GENERATED FROM PYTHON SOURCE LINES 77-78

Now run the dynamics:

.. GENERATED FROM PYTHON SOURCE LINES 78-81

.. code-block:: default

    print("Beginning dynamics...")
    printenergy()
    dyn.run(500)




.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Beginning dynamics...
    Energy per atom: Epot = -1038.903eV  Ekin = 0.000eV (T=  0K)  Etot = -1038.903eV
    Energy per atom: Epot = -1038.903eV  Ekin = 0.000eV (T=  0K)  Etot = -1038.903eV
    /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/torchani-2.2.3.dev1+gc94ad7a-py3.8.egg/torchani/aev.py:249: UserWarning: __floordiv__ is deprecated, and its behavior will change in a future version of pytorch. It currently rounds toward 0 (like the 'trunc' function NOT 'floor'). This results in incorrect rounding for negative values. To keep the current behavior, use torch.div(a, b, rounding_mode='trunc'), or for actual floor division, use torch.div(a, b, rounding_mode='floor').
      pair_sizes = counts * (counts - 1) // 2
    Energy per atom: Epot = -1038.865eV  Ekin = 0.016eV (T=124K)  Etot = -1038.849eV
    Energy per atom: Epot = -1038.882eV  Ekin = 0.027eV (T=205K)  Etot = -1038.855eV
    Energy per atom: Epot = -1038.884eV  Ekin = 0.018eV (T=136K)  Etot = -1038.866eV
    Energy per atom: Epot = -1038.885eV  Ekin = 0.033eV (T=254K)  Etot = -1038.852eV
    Energy per atom: Epot = -1038.883eV  Ekin = 0.034eV (T=261K)  Etot = -1038.849eV
    Energy per atom: Epot = -1038.870eV  Ekin = 0.019eV (T=147K)  Etot = -1038.851eV
    Energy per atom: Epot = -1038.861eV  Ekin = 0.044eV (T=337K)  Etot = -1038.818eV
    Energy per atom: Epot = -1038.874eV  Ekin = 0.034eV (T=263K)  Etot = -1038.840eV
    Energy per atom: Epot = -1038.875eV  Ekin = 0.052eV (T=402K)  Etot = -1038.823eV
    Energy per atom: Epot = -1038.875eV  Ekin = 0.043eV (T=332K)  Etot = -1038.832eV

    True




.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  17.400 seconds)


.. _sphx_glr_download_examples_ase_interface.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download sphx-glr-download-python

     :download:`Download Python source code: ase_interface.py <ase_interface.py>`



  .. container:: sphx-glr-download sphx-glr-download-jupyter

     :download:`Download Jupyter notebook: ase_interface.ipynb <ase_interface.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
